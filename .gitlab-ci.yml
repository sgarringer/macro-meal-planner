include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - security
  - build
  - sast
  - release

variables:
  DOCKER_DRIVER: overlay2
  NODE_VERSION: "24"
  SAST_EXCLUDED_PATHS: "backend/node_modules,frontend/node_modules,backend/dist,frontend/build"
  SCAN_KUBERNETES_MANIFESTS: "false"
  SAST_ANALYZER_IMAGE_PREFIX: "registry.gitlab.com/security-products"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  CI_JOB_TOKEN: $CI_JOB_TOKEN
  SAST_DEFAULT_ANALYZERS: "nodejs-scan,semgrep,eslint"
  SAST_SEMGREP_LEVEL: "HIGH"
  SECURE_LOG_LEVEL: "debug"
  
# Override the SAST configuration to enable the appropriate scanners for JavaScript/Node.js
sast:
  stage: sast
  variables:
    SAST_ANALYZER_IMAGE_PREFIX: registry.gitlab.com/security-products
    SAST_DEFAULT_ANALYZERS: "nodejs-scan,semgrep"
  artifacts:
    reports:
      sast: gl-sast-report.json

  # ...existing code...

# Build Docker image using Kaniko
build:
  stage: build
  image: 
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - export VERSION=v0.$CI_PIPELINE_IID
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${VERSION}"
      --destination "${CI_REGISTRY_IMAGE}:latest"
      --build-arg "VITE_API_BASE_URL=${VITE_API_BASE_URL}"
      --build-arg "JWT_SECRET=${JWT_SECRET}"
      --build-arg "ADMIN_USERNAME=${ADMIN_USERNAME}"
      --build-arg "ADMIN_PASSWORD=${ADMIN_PASSWORD}"
      --insecure
      --skip-tls-verify

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch

  # ...existing code...

# Create a release with auto-incrementing version number
release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  variables:
    GIT_SSL_NO_VERIFY: "1"
    # Fallback names in case the client respects different env vars
    GITLAB_SKIP_TLS_VERIFY: "true"
    SKIP_TLS_VERIFY: "true"

  rules:
    - if: $CI_COMMIT_TAG
      when: never                                  # Do not run this job when a tag is created manually
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch
  script:
    - echo "running release_job for v0.$CI_PIPELINE_IID"
  release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v0.$CI_PIPELINE_IID'                # The version is incremented per pipeline.
    description: 'v0.$CI_PIPELINE_IID'
    ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.

# Dependency scanning using Trivy. This job scans the repository's backend
# and frontend directories for dependency vulnerabilities and fails the
# pipeline when HIGH or CRITICAL vulnerabilities are found.
trivy-deps-scan:
  stage: security
  image: aquasec/trivy:latest
  variables:
    TRIVY_SEVERITY: "CRITICAL,HIGH"
  before_script:
    - trivy --version
    - apk add jq
  script:
    - EXIT=0
    - trivy fs backend --scanners vuln --severity $TRIVY_SEVERITY --ignore-unfixed --skip-dirs node_modules --format gitlab --output trivy-deps-report-backend.json --exit-code 1 --no-progress || EXIT=$?
    - trivy fs frontend --scanners vuln --severity $TRIVY_SEVERITY --ignore-unfixed --skip-dirs node_modules --format gitlab --output trivy-deps-report-frontend.json --exit-code 1 --no-progress || EXIT=$?
    - jq -s '.[0] + .[1]' trivy-deps-report-backend.json trivy-deps-report-frontend.json > gl-dependency-scanning-report.json
    - if [ "$EXIT" -ne 0 ]; then echo "Trivy found HIGH/CRITICAL vulnerabilities"; exit $EXIT; fi
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    paths:
      - gl-dependency-scanning-report.json
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"