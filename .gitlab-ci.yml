include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - test
  - build
  - build-test
  - sast
  - release

variables:
  DOCKER_DRIVER: overlay2
  NODE_VERSION: "24"
  SAST_EXCLUDED_PATHS: "backend/node_modules,frontend/node_modules,backend/dist,frontend/build"
  SCAN_KUBERNETES_MANIFESTS: "false"
  SAST_ANALYZER_IMAGE_PREFIX: "registry.gitlab.com/security-products"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  CI_JOB_TOKEN: $CI_JOB_TOKEN
  SAST_DEFAULT_ANALYZERS: "nodejs-scan,semgrep,eslint"
  SAST_SEMGREP_LEVEL: "HIGH"
  SECURE_LOG_LEVEL: "debug"
  
# Override the SAST configuration to enable the appropriate scanners for JavaScript/Node.js
sast:
  stage: sast
  variables:
    SAST_ANALYZER_IMAGE_PREFIX: registry.gitlab.com/security-products
    SAST_DEFAULT_ANALYZERS: "nodejs-scan,semgrep"
  artifacts:
    reports:
      sast: gl-sast-report.json

test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - echo "Testing backend..."
    - cd backend && npm ci --prefer-offline --no-audit
    - npm test || echo "No backend tests defined, skipping backend test step"
    - echo "Testing frontend..."
    - cd ../frontend && npm ci --prefer-offline --no-audit
    - npm test -- --watchAll=false --passWithNoTests || echo "No frontend tests defined, skipping frontend test step"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - backend/node_modules/
      - frontend/node_modules/
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Build Docker image using Kaniko
build:
  stage: build
  image: 
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - export VERSION=v0.$CI_PIPELINE_IID
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${VERSION}"
      --destination "${CI_REGISTRY_IMAGE}:latest"
      --build-arg "VITE_API_BASE_URL=${VITE_API_BASE_URL}"
      --build-arg "JWT_SECRET=${JWT_SECRET}"
      --build-arg "ADMIN_USERNAME=${ADMIN_USERNAME}"
      --build-arg "ADMIN_PASSWORD=${ADMIN_PASSWORD}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch

# Build test image using Kaniko for test environment
build-test:
  stage: build-test
  image: 
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - export VERSION=v0.$CI_PIPELINE_IID
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:test-${VERSION}"
      --destination "${CI_REGISTRY_IMAGE}:test-latest"
      --build-arg "VITE_API_BASE_URL=${VITE_API_BASE_URL_TEST}"
      --build-arg "JWT_SECRET=${JWT_SECRET_TEST}"
      --build-arg "ADMIN_USERNAME=${ADMIN_USERNAME_TEST}"
      --build-arg "ADMIN_PASSWORD=${ADMIN_PASSWORD_TEST}"
  rules:
    - if: $CI_COMMIT_BRANCH == 'test'  # Run this job when commits are pushed or merged to the branch named test

# Create a release with auto-incrementing version number
release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: never                                  # Do not run this job when a tag is created manually
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch
  script:
    - echo "running release_job for v0.$CI_PIPELINE_IID"
  release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v0.$CI_PIPELINE_IID'                # The version is incremented per pipeline.
    description: 'v0.$CI_PIPELINE_IID'
    ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.