include:
  - template: Security/SAST.gitlab-ci.yml

stages:
  - security       # Filesystem scan (pre-build)
  - sast
  - build          # Kaniko build
  - post-build     # Image scan (post-build)
  - release

variables:
  DOCKER_DRIVER: overlay2
  NODE_VERSION: "24"
  SAST_EXCLUDED_PATHS: "backend/node_modules,frontend/node_modules,backend/dist,frontend/build"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:v0.$CI_PIPELINE_IID
  TRIVY_CACHE_DIR: ".trivycache/"

# 1. Pre-build: Scans source code for dependency vulnerabilities
trivy-fs:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  cache:
    paths: [".trivycache/"]
  script:
    - trivy fs --exit-code 1 --severity CRITICAL,HIGH --cache-dir .trivycache/ .
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# 2. Build: Kaniko with your specific SSL bypass flags
build:
  stage: build
  image: 
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  script:
    - export VERSION=v0.$CI_PIPELINE_IID
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${VERSION}"
      --destination "${CI_REGISTRY_IMAGE}:latest"
      --build-arg "VITE_API_BASE_URL=${VITE_API_BASE_URL}"
      --build-arg "JWT_SECRET=${JWT_SECRET}"
      --build-arg "ADMIN_USERNAME=${ADMIN_USERNAME}"
      --build-arg "ADMIN_PASSWORD=${ADMIN_PASSWORD}"
      --insecure
      --skip-tls-verify
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# 3. Post-build: Scans the final image (includes --insecure for your registry)
trivy-image:
  stage: post-build
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    TRIVY_USERNAME: $CI_REGISTRY_USER
    TRIVY_PASSWORD: $CI_REGISTRY_PASSWORD
    TRIVY_AUTH_URL: $CI_REGISTRY
    TRIVY_INSECURE: "true"  # Tells Trivy to ignore SSL cert issues for the registry
  cache:
    paths: [".trivycache/"]
  script:
    # Added --insecure flag here to match your registry setup
    - trivy image --insecure --exit-code 1 --severity CRITICAL,HIGH --cache-dir .trivycache/ $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

sast:
  stage: sast
  variables:
    SAST_ANALYZER_IMAGE_PREFIX: ://registry.gitlab.com
    SAST_DEFAULT_ANALYZERS: "nodejs-scan,semgrep"
  artifacts:
    reports:
      sast: gl-sast-report.json

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  variables:
    GIT_SSL_NO_VERIFY: "1"
    # Fallback names in case the client respects different env vars
    GITLAB_SKIP_TLS_VERIFY: "true"
    SKIP_TLS_VERIFY: "true"
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - echo "running release_job for v0.$CI_PIPELINE_IID"
  release:
    tag_name: 'v0.$CI_PIPELINE_IID'
    description: 'v0.$CI_PIPELINE_IID'
    ref: '$CI_COMMIT_SHA'